<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ë£Œí”½</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- 1. Orbit í°íŠ¸ ë¡œë“œ ì œê±° -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Tailwind CSS ê¸°ë³¸ ì„¤ì • */
        body { font-family: 'Inter', sans-serif; } /* ê¸°ë³¸ í°íŠ¸ëŠ” Inter ìœ ì§€ */

        /* --- 1. Orbit í°íŠ¸ í´ë˜ìŠ¤ ì œê±° --- */
        /* .font-orbit { ... } */

        /* --- â˜… ìŠ¤í¬ë¡¤ ë²„ê·¸ ìˆ˜ì •ìš© CSS â˜… --- */
        .main-scroll-area {
            position: relative; /* ìì‹ ìš”ì†Œì˜ offsetTop ê³„ì‚° ê¸°ì¤€ì ì´ ë˜ë„ë¡ ì„¤ì • */
        }

        /* --- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ --- */
        .horizontal-scroll-wrapper { display: flex; align-items: center; overflow: hidden; }
        .horizontal-scroll-buttons { display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; white-space: nowrap; padding-bottom: 8px; margin-left: 8px; }
        .horizontal-scroll-buttons::-webkit-scrollbar { display: none; }
        .tag-button { flex-shrink: 0; }
        .horizontal-scroll-content { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; scroll-behavior: smooth; }
        .horizontal-scroll-content::-webkit-scrollbar { display: none; }
        .recipe-card-container { flex: 0 0 auto; scroll-snap-align: start; width: 85%; max-width: 320px; }
        .card-content-grid { display: grid; grid-template-columns: auto 1fr; gap: 1rem; }
        .sauce-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .sauce-details.open { max-height: 500px; transition: max-height 0.5s ease-in; }
        .channel-btn.active { background-color: theme('colors.indigo.600'); color: white; padding-left: 0.75rem; padding-right: 0.75rem; border-radius: 9999px; }
        .ingredient-list { list-style-type: disc; list-style-position: inside; padding-left: 0.5rem; margin-bottom: 0.5rem; }

    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <div class="max-w-md w-full mx-auto bg-white rounded-lg shadow-md flex flex-col flex-1 overflow-hidden my-4">
        <!-- ìƒë‹¨ ê³ ì •: ì œëª©, ê²€ìƒ‰, í•„í„° -->
        <div class="px-6 pt-8 pb-2 border-b"> <!-- pt-8 (ìƒë‹¨ ì—¬ë°±) -->
            <!-- --- 1 & 2. í°íŠ¸ í´ë˜ìŠ¤ ì œê±°, ì—¬ë°± ìˆ˜ì • (mb-2 -> mb-6) â˜… --- -->
            <h1 class="text-4xl font-bold text-center mb-6 text-gray-800">ì¬ë£Œí”½</h1>
            <!-- 1. placeholder í…ìŠ¤íŠ¸ ë³€ê²½ -->
            <div class="mb-4">
                <input type="search" id="searchInput" placeholder="ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”! (900+ ì‡¼ì¸  ëŒ€ê¸°ì¤‘ğŸ³)" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="horizontal-scroll-wrapper mt-4">
                 <div id="channelFilters" class="horizontal-scroll-buttons gap-2 w-full">
                     <span class="text-xs text-gray-500">ì±„ë„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                 </div>
            </div>
        </div>

        <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
        <!-- --- â˜… 3. ì„¹ì…˜ ê°„ê²© ìˆ˜ì • (space-y-2 -> space-y-4) â˜… --- -->
        <div id="mainScrollArea" class="flex-1 overflow-y-auto px-6 pt-2 space-y-8 main-scroll-area">
            <p class="text-sm text-gray-700 text-center mb-1 px-4 py-2 bg-gray-100 rounded-md">ì¬ë£Œ í”½! ìš”ë¦¬ ì‚¬ì§„ ëˆ„ë¥´ë©´ ë ˆì‹œí”¼ ë“±ì¥ ğŸ¬</p>

            <!-- ì¶”ì²œ ìš”ë¦¬ ì„¹ì…˜ -->
            <section id="recommendations" class="relative">
                <div class="flex items-center justify-between mb-3">
                     <!-- --- 1. í°íŠ¸ í´ë˜ìŠ¤ ì œê±° â˜… --- -->
                    <h2 class="text-xl font-semibold text-gray-700">ì¶”ì²œí”½ ì˜¤ëŠ˜ì˜ ìš”ë¦¬ ğŸ‘‰</h2>
                    <button id="refreshRecommendations" title="ì¶”ì²œ ìƒˆë¡œê³ ì¹¨" class="text-gray-500 hover:text-blue-600 focus:outline-none p-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                    </button>
                </div>
                <div class="relative">
                    <div id="recommendationResults" class="horizontal-scroll-content space-x-4 pb-4">
                        <p class="text-gray-500 self-center w-full text-center">ì¶”ì²œ ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </section>

            <!-- ê²€ìƒ‰ ê²°ê³¼ ì„¹ì…˜ -->
            <section id="results" class="relative mt-4">
                 <!-- --- 1. í°íŠ¸ í´ë˜ìŠ¤ ì œê±° â˜… --- -->
                <h2 class="text-xl font-semibold mb-20 text-gray-700" id="searchResultsTitle">ì¬ë£Œí”½ ê²€ìƒ‰ ê²°ê³¼ ğŸ‘‰</h2>
                <div class="relative">
                    <div id="searchResults" class="horizontal-scroll-content space-x-4 pb-4">
                        <p class="text-gray-500 self-center w-full text-center">ì–´ë–¤ ì¬ë£Œë¡œ í”½í• ê¹Œìš”?ğŸ¥‘ğŸğŸ¥©</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- --- GA íƒœê·¸ â˜… --- -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4STF6RT3N4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4STF6RT3N4'); 
    </script>
    <!-- --- GA íƒœê·¸ ë --- -->


    <footer class="text-center px-4 pt-2 pb-4 mt-auto">
        <p class="text-[10px] text-gray-500 leading-relaxed">
            â€˜ì¬ë£Œí”½â€™ì€ AI/Ops ê¸°ë°˜ ê°œì¸ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.
            <br>
            <a href="https://allesgute965.notion.site/29ab103176b2801b8b66fd5a03ac8cbf" target="_blank"
               class="text-blue-600 font-medium mx-1 group"> 
               ì œì‘ ê³¼ì •ê³¼ ë¬¸ì œ í•´ê²° ìŠ¤í† ë¦¬ëŠ” ğŸ‘‰
               <span class="group-hover:underline">Notion</span> 
            </a>
        </p>
    </footer>


    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ---
        const searchInput = document.getElementById('searchInput');
        const searchResultsDiv = document.getElementById('searchResults');
        const recommendationResultsDiv = document.getElementById('recommendationResults');
        const channelFiltersDiv = document.getElementById('channelFilters');
        const scrollContainer = document.getElementById('mainScrollArea');
        const resultsSection = document.getElementById('results');
        const searchTitleElement = document.getElementById('searchResultsTitle');

        let selectedChannelId = null;

        // --- ì„¸ì…˜ ID ê´€ë¦¬ í•¨ìˆ˜ ---
        function getSessionId() {
            let sessionId = sessionStorage.getItem('recipeSessionId');
            if (!sessionId) {
                sessionId = crypto.randomUUID();
                sessionStorage.setItem('recipeSessionId', sessionId);
            }
            return sessionId;
        }

        // --- ì¸ë„¤ì¼ í´ë¦­ ë¡œê¹… í•¨ìˆ˜ ---
        async function handleThumbnailClick(event, videoId, videoUrl, sourceSection) {
            event.preventDefault(); 
            const sessionId = getSessionId();

            console.log(`Click logged: videoId=${videoId}, source=${sourceSection}, sessionId=${sessionId}`);

            if (typeof gtag === 'function') {
                gtag('event', 'click_youtube', {
                  'video_id': videoId, 'source_section': sourceSection, 'session_id': sessionId
                });
            }

            try {
                await fetch('/api/log-click', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId, video_id: videoId, source_section: sourceSection
                    })
                });
            } catch (e) { console.error("Failed to log click to backend DB:", e); }

            window.open(videoUrl, '_blank');
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (createRecipeCard, toggleSauce) ---
         function createRecipeCard(recipe, sourceSection = 'unknown') {
            const videoUrl = `https://www.youtube.com/watch?v=${recipe.video_id}`;
            const thumbnailUrl = `https://i.ytimg.com/vi/${recipe.video_id}/mqdefault.jpg`;

            let mainIngredientsHtml = '';
            let sauceIngredientsHtml = '';
            let sauceToggleHtml = '';

            try {
                const ingredientsJsonString = recipe.ai_ingredients;
                let ingredientsData = {};
                if (ingredientsJsonString && typeof ingredientsJsonString === 'string' && ingredientsJsonString.trim().startsWith('{')) {
                     ingredientsData = JSON.parse(ingredientsJsonString);
                }

                const mainList = ingredientsData.main || [];
                if (mainList.length > 0) {
                    mainIngredientsHtml = mainList.map(item => `<li class="text-sm text-gray-600 truncate">${item}</li>`).join('');
                } else {
                    mainIngredientsHtml = '<li class="text-sm text-gray-500 italic">ì£¼ìš” ì¬ë£Œ ì •ë³´ ì—†ìŒ</li>';
                }

                const sauceList = ingredientsData.sauce || [];
                if (sauceList.length > 0) {
                    sauceIngredientsHtml = sauceList.map(item => `<li class="text-sm text-gray-600 truncate">${item}</li>`).join('');
                    sauceToggleHtml = `
                        <button onclick="toggleSauce(this)" class="mt-2 text-sm text-blue-600 hover:text-blue-800 focus:outline-none">
                            ì†ŒìŠ¤ ë³´ê¸° â–¼
                        </button>
                        <div class="sauce-details ml-4 mt-1 border-l-2 border-blue-200 pl-3">
                            <ul class="list-disc list-inside">${sauceIngredientsHtml}</ul>
                        </div>
                    `;
                }
            } catch (e) { console.error(`[${recipe.video_id}] Failed to parse ai_ingredients JSON:`, recipe.ai_ingredients, e); }

            const cardContainer = document.createElement('div');
            cardContainer.className = 'recipe-card-container';
            cardContainer.innerHTML = `
                <div class="relative bg-gray-50 p-4 rounded-md border border-gray-200 shadow-sm h-full flex flex-col">
                    <h3 class="font-semibold text-md mb-2 text-gray-800 truncate">${recipe.title || 'ì œëª© ì—†ìŒ'}</h3>
                    <div class="card-content-grid flex-1 overflow-hidden">
                        
                        <div class="flex flex-col">
                            <a onclick="handleThumbnailClick(event, '${recipe.video_id}', '${videoUrl}', '${sourceSection}')" 
                            href="${videoUrl}" target="_blank" class="block rounded overflow-hidden aspect-[9/16] mb-1 relative group">
                                <img src="${thumbnailUrl}" alt="${recipe.title || 'ë ˆì‹œí”¼ ì˜ìƒ ì¸ë„¤ì¼'}" class="w-full h-full object-cover" loading="lazy">


                            </a>
                        
                            <p class="text-[0.60rem] leading-tight text-gray-500 truncate text-left w-full"> 
                                ì¶œì²˜ ${recipe.channel_name || 'ì•Œ ìˆ˜ ì—†ìŒ'} (YouTube)
                            </p>
                        </div>
                        <div class="overflow-y-auto text-sm pr-1">
                            <h4 class="font-medium text-gray-700 mb-1">ì¬ë£Œ:</h4>
                            <ul class="ingredient-list">
                                ${mainIngredientsHtml}
                            </ul>
                            ${sauceToggleHtml}
                        </div>
                    </div>
                </div>
            `;
            return cardContainer;
        }

        function toggleSauce(button) {
             const detailsDiv = button.nextElementSibling;
             const isOpen = detailsDiv.classList.contains('open');
             detailsDiv.classList.toggle('open');
             button.textContent = isOpen ? 'ì†ŒìŠ¤ ë³´ê¸° â–¼' : 'ì†ŒìŠ¤ ì ‘ê¸° â–²';
        }

        // --- API í˜¸ì¶œ í•¨ìˆ˜ (fetchAndDisplay - ìŠ¤í¬ë¡¤ ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ) ---
         async function fetchAndDisplay(url, targetDiv, placeholder) {
            targetDiv.innerHTML = `<p class="text-gray-500 self-center w-full text-center">${placeholder}</p>`;
            // (searchTitleElementëŠ” ì „ì—­ ë³€ìˆ˜)
            try {
                const absoluteUrl = window.location.origin + url;
                const response = await fetch(absoluteUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                targetDiv.innerHTML = '';
                if (!Array.isArray(data) || data.length === 0) {
                     targetDiv.innerHTML = '<p class="text-gray-500 self-center w-full text-center">ì•—, ì´ë²ˆ ì¬ë£ŒëŠ” ì—†ì–´ìš”!<br>ë‹¤ë¥¸ ì¬ë£Œë¡œ í”½í•´ë³¼ê¹Œìš”? ğŸ¥šğŸ…ğŸ§ˆ</p>';
                     if (searchTitleElement && targetDiv === searchResultsDiv) {
                         searchTitleElement.classList.remove('mb-3');
                         searchTitleElement.classList.add('mb-20');
                     }
                } else {
                     if (url.startsWith('/api/channels')) {
                         loadChannelFilterButtons(data);
                     } else { // ê²€ìƒ‰ ë˜ëŠ” ì¶”ì²œ ê²°ê³¼
                         const sourceSection = url.startsWith('/api/recommendations') ? 'recommendation' : 'search';
                         data.forEach(recipe => {
                             targetDiv.appendChild(createRecipeCard(recipe, sourceSection));
                         });
                         if (searchTitleElement && targetDiv === searchResultsDiv) {
                             searchTitleElement.classList.remove('mb-20');
                             searchTitleElement.classList.add('mb-3');
                         }

                         // --- â˜…â˜…â˜… ìŠ¤í¬ë¡¤ ë²„ê·¸ ìˆ˜ì • ë¡œì§ (ì˜¬ë°”ë¥¸ ë²„ì „) â˜…â˜…â˜… ---
                         if (targetDiv === searchResultsDiv) {
                             setTimeout(() => {
                                 if (scrollContainer && resultsSection) {
                                     const scrollTopTarget = resultsSection.offsetTop - 8; 
                                     scrollContainer.scrollTo({ 
                                         top: scrollTopTarget,
                                         behavior: 'smooth' 
                                     });
                                     console.log(`Scrolling container to: ${scrollTopTarget}`);
                                 }
                             }, 100); // 100ms ì§€ì—°
                         }
                         // --- â˜…â˜…â˜… ìŠ¤í¬ë¡¤ ë¡œì§ ë â˜…â˜…â˜… ---
                     }
                }
            } catch (error) {
                console.error('Fetch error:', error);
                targetDiv.innerHTML = `<p class="text-red-500 self-center w-full text-center">ì˜¤ë¥˜: ${error.message}</p>`;
                 if (searchTitleElement && targetDiv === searchResultsDiv) {
                     searchTitleElement.classList.remove('mb-3');
                     searchTitleElement.classList.add('mb-20');
                 }
            }
        }

        // --- ì±„ë„ ê´€ë ¨ í•¨ìˆ˜ (loadChannelFilterButtons, selectChannel) ---
        function loadChannelFilterButtons(channels) {
            channelFiltersDiv.innerHTML = '';
            const allButton = document.createElement('button');
            allButton.textContent = 'All channels';
            allButton.className = 'tag-button channel-btn active bg-indigo-600 text-white text-xs font-medium px-3 py-1 rounded-full focus:outline-none';
            allButton.onclick = () => selectChannel(null, allButton);
            channelFiltersDiv.appendChild(allButton);

            if (channels.length > 0) {
                channels.forEach(channel => {
                    const button = document.createElement('button');
                    button.textContent = channel.name;
                    button.className = 'tag-button channel-btn bg-gray-200 text-gray-800 text-xs font-medium px-3 py-1 rounded-full hover:bg-gray-300 focus:outline-none';
                    button.onclick = () => selectChannel(channel.id, button);
                    channelFiltersDiv.appendChild(button);
                });
            }
        }

        function selectChannel(channelId, clickedButton) {
            selectedChannelId = channelId;
            document.querySelectorAll('.channel-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
            });
            clickedButton.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
            clickedButton.classList.add('active', 'bg-indigo-600', 'text-white');
            triggerSearch(searchInput.value.trim());
        }

        // --- ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜ (triggerSearch - ìŠ¤í¬ë¡¤ ë¡œì§ ì œê±°ë¨) ---
        function triggerSearch(keyword) {
            let searchUrl = '/api/search';
            const params = new URLSearchParams();
            const sessionId = getSessionId(); 

            if (keyword) {
                params.append('keyword', keyword);
                if (typeof gtag === 'function') {
                    gtag('event', 'search', {
                      'search_term': keyword, 'channel_filter': selectedChannelId || 'all', 'session_id': sessionId
                    });
                }
            }
            if (selectedChannelId) {
                params.append('channel_id', selectedChannelId);
            }
            params.append('session_id', sessionId); 

            const queryString = params.toString();
            searchUrl += `?${queryString}`;

            fetchAndDisplay(searchUrl, searchResultsDiv, 'ê²€ìƒ‰ ì¤‘...');

            // (ìŠ¤í¬ë¡¤ ë¡œì§ì€ fetchAndDisplayë¡œ ì´ë™ë¨)
        }

        // --- í™”ì‚´í‘œ ê´€ë ¨ í•¨ìˆ˜ ì œê±°ë¨ ---

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                triggerSearch(searchInput.value.trim());
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplay('/api/recommendations', recommendationResultsDiv, 'ì¶”ì²œ ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            fetchAndDisplay('/api/channels', channelFiltersDiv, 'ì±„ë„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

            const refreshButton = document.getElementById('refreshRecommendations');
            if (refreshButton) {
                 refreshButton.addEventListener('click', () => {
                    fetchAndDisplay('/api/recommendations', recommendationResultsDiv, 'ì¶”ì²œ ìƒˆë¡œê³ ì¹¨ ì¤‘...');
                });
            }
             // í™”ì‚´í‘œ ê´€ë ¨ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨
        });

    </script>
    <!-- â˜…â˜…â˜… 4. GA íƒœê·¸ ì¶”ê°€ (head ë°– body ëë„ ê´œì°®ìŒ) â˜…â˜…â˜… -->
    <!-- G-XXXXXXXXXX ë¥¼ ë³¸ì¸ì˜ ì¸¡ì • IDë¡œ êµì²´í•˜ì„¸ìš” -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=[G-4STF6RT3N4]"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '[G-4STF6RT3N4]'); 
    </script>
    <!-- â˜…â˜…â˜… GA íƒœê·¸ ë â˜…â˜…â˜… -->
</body>
</html>

